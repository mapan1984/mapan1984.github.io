### 概述

HTTPS是HTTP协议与SSL/TLS协议的组合，SSL(Secure Sockets Layer)是网景公司发明协议，用于解决HTTP协议明文传输造成的安全泄露问题，而后，因为SSL应用广泛，成为互联网的一个标准，并改名为TLS(Transport Layer Security)。

SSL作为一种安全协议，它在传输层提供对网络连接加密的功能。对于应用层而言，它是透明的，数据在传递到应用层之前就已经完成了加密和解密的过程。

### TLS/SSL

利用openssl分别生成服务器和客户端的私钥和公钥：

    $ openssl genrsa -out server.key 1024
    $ openssl genrsa -out client.key 1024

    $ openssl rsa -in server.key -pubout -out server.pem
    $ openssl rsa -in client.key -pubout -out client.pem

为了避免第三方攻击，需要第三方CA(Certificate Authority)为站点颁发数字证书，这个证书具有CA通过自己的公钥和私钥实现的签名。

为了得到签名，服务器需要通过自己的私钥生成CSR(Certificate Signing Request)文件。CA将通过这个文件颁发属于该服务器的签名证书，只要通过CA机构就能验证证书是否合法。


自己扮演CA机构，给自己的服务器颁发证书：

    // 生成私钥
    $ openssl genrsa -out ca.key 1024
    // 生成CSR文件
    $ openssl req -new -key ca.key -out ca.csr
    // 通过私钥子签名生成证书
    $ openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt

生成服务器的证书：

    // 生成服务器CSR文件
    $ openssl req -new -key server.key -out server.csr
    // 生成服务器证书
    $ openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -in server.csr -out server.crt

### 原理

1. 客户端首先会将自己支持的加密算法，打个包告诉服务器端。
2. 服务器端从客户端发来的加密算法中，选出一组加密算法和HASH算法，并将自己的身份信息以**电子证书**(而证书中包含了服务器的名称和地址，服务器加密用的公钥，签名颁发机构名称，来自签名颁发机构的签名等，在建立连接前，会通过证书中的签名确认收到的公钥是来自目标服务器的，从而产生信任关系，避免中间人攻击)的形式发回给客户端。
3. 客户端收到了服务器发来的数据包后，会做这么几件事情：
    1. 验证一下证书是否合法。一般来说，证书是用来标示一个站点是否合法的标志。如果说该证书是由权威的第三方颁发和签名的，则说明证书合法。
    2. 如果证书合法，或者客户端接受和信任了不合法的证书，则客户端就会随机产生一串序列号，使用服务器发来的公钥进行加密。这时候，一条返回的消息就基本就绪。
    3. 最后使用服务器挑选的HASH算法，将刚才的消息使用刚才的随机序列进行加密，生成相应的消息校验值，与刚才的消息一同发还给服务器。
4. 服务器接受到客户端发来的消息后，会做这么几件事情：
    1. 使用私钥解密中公钥加密的消息，得到客户端产生的随机序列号。
    2. 使用该随机序列号，对该消息进行HASH加密，验证的到的校验值是否与客户端发来的一致。如果一致则说明消息未被篡改，可以信任。
    3. 最后，使用该随机序列号，加上之前选择的加密算法，加密一段握手消息，发还给客户端。同时发还消息的HASH值。
5. 客户端收到服务器端的消息后，接着做这么几件事情：
    1. 计算接收到的消息的HASH值是否与发回的HASH值一致。
    2. 若一致，检查消息是否为握手消息。
6. 握手结束后，客户端和服务器端使用握手阶段产生的随机数以及挑选出来的加密算法进行对称加解密的传输。

服务器的电子证书是为了防止**中间人**在传递信息是冒充自己而出现的认证方式，网站运营商会提前向CA(数字证书认证机构，Certificate Authority)申请一个电子证书，CA会通过自己的私钥将网站的公钥和网站的各种相关信息，比如域名等等进行加密，加密后形成电子证书，颁发给申请者。
