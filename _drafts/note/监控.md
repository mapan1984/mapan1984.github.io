# 第一次 SRE 分享会记录：基于时序数据的监控告警

## 1. 分享

### 1. 监控系统

1. 概念：收集，处理，分析服务的实时信息
2. 基本要求：
    1. 注重分析性任务
    2. 要求稳定性与易于维护
3. 设计模型：
    1. 探针
    2. 时序数据

### 2. 时序数据：以时间为索引的数据

1. 分类：
    1. 监控信息：系统 CPU 随时间的使用率
    2. 状态信息：快递随时间的状态变化
2. 业务特点：
    1. 持续、均匀、大量的数据流入
    2. 操作基本为插入操作
    3. 对近期数据的关注度较高
    4. 需要多维查询、聚合计算

### 3. 实践

1. 数据模型：*谁*在*何时、何地*做了*什么事*

        <metric> <timestamp> <value> <tagk_1>=<tagv_2> [<tagk_N>=<tagv_N> ...]

2. 数据收集：
    1. 内部埋点
    2. agent 代理

3. 数据存储：
    1. 存储引擎：LSM Tree
         1. 将新增的数据以红黑树的方式维护在内存中，达到指定的限制后将这些修改顺序批量的写入磁盘，消除随机的磁盘写；
         2. 磁盘中的数据定期做合并操作，使之重新合并为一棵树，便于查询；
         3. 记录日志用于数据恢复。

    2. 时序数据库介绍
        1. Prometheus
            1. 更强大的分析、检索语言
            2. 单节点
        2. OpenTSDB
            1. 存储基于 HBase，易于扩展

4. Prometheus 架构和功能
    1. 以存储为核心，服务分离，提供分析，告警等服务

4. OpenTSDB 的存储优化
    1. 维护一张与数据的 `metric`, `tagk`, `tagv` 等值对应的 ID 表，用唯一对应的 ID 来替代字符串俩进行存储
    2. 数据表将一段时间内数据存储为一行，以  `metric`, `timestamp`（前缀部分）, `tagk`, `tagv` 为一行的`RowKey`来定位行，以 `timestamp`（后缀部分） 作为行内偏移定位数据值

## 2. 讨论

### 1. 为什么分享时序数据库，时序数据库对 SRE 的作用（关系）？

SRE 对服务的运营需要对服务建立起监控系统，将服务的信息按时序进行存储、分析，这些监控数据有以下特点：

1. 以时间推移变化的状态信息
1. 持续、均匀、大量的数据流入
2. 写多读少
3. 对数据的分析要求高

而时序数据库正好满足这类需求。

