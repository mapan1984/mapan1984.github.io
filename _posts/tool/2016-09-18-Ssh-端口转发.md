---
title: ssh端口转发
tags: [ssh]
---

### Local Forwarding

    host1(local-host)<----->host2(middle-host)<----->host3(target-host)

host1是本地主机，host3是远程主机(host1与host3无法连通)，host2可以同时连接host1和host3；通过host2，连接host1和host3。

* host1: local-host
* host2: middle-host
* host3: target-host

在local-host上执行:

    $ ssh -L <local-host-port>:<target-host>:<target-host-port> <middle-host>

指定本地ssh监听local-host-port，middle-host将所有数据，转发到target-host的target-host-port

比如在host1上执行:

    $ ssh -L 1080:host3:21 host2
    $ ftp localhost:1080

当使用ftp请求localhost:1080时，请求内容会通过host2转发给host3:21(21为ftp默认端口)，也就是说，使用ftp访问localhost:1080就等同与访问host3:21

*在选择端口号时要注意非管理员帐号是无权绑定 1-1023 端口的，所以一般是选用一个 1024-65535 之间的并且尚未使用的端口号即可*

### Remote Forwarding

    host1(remote-host)<------host2(local-host)<----->host3(target-host)

当host1无法连接host2和host3，而host2可以连接host1与host3时，可以在host2上使用远程端口转发来完成host1和host3的连接。

* host1: remote-host
* host2: local-host
* host3: target-host

在local-host上执行:

    $ ssh -R <remote-host-port>:<target-host>:<target-host-port> <remote-host>

使remote-host监听remote-host-port端口，然后将所有数据经由local-host转发到target-host的target-host-port

比如在host2上执行:

    $ ssh -R 1080:host3:21 host1

在host1上执行:

    $ ftp localhost:1080

### 动态转发

动态转发不指定目标host：

    $ ssh -D <local-port> <middle-host>

比如:

    $ ssh -D 1080 middle-host

之后我们可以使用localhost:1080作为正常的socks代理来使用

### other

p指定端口

    $ ssh -p 1080 user@host

N表示只连接远程主机，不打开远程shell；T表示不为这个连接分配tty。这两个参数一起使用，表示这个ssh只用来传递数据，不执行远程操作。

    $ ssh -NT -D 1080 host

f表示ssh连接成功后，转入后台运行，可以在不中断ssh连接的情况下，在本地shell中执行其他操作，要关闭这个后台连接，就只有用kill命令去杀掉进程。

    $ ssh -f -D 1080 host
