---
title: Unix网络编程-Web服务器
categories: [Unix]
tags: [C]
---

### Web基础

Web客户端和服务器的交互用的是一个基于文本的应用级协议 —— HTTP(Hypertext Transfer Protocol)。Http是一个简单的协议。一个Web客户端(即浏览器)打开一个到服务器的因特网连接，并且请求某些内容。服务器响应所请求的内容，然后关闭连接。浏览器读取这些内容，并把它显示在屏幕上。

Web与常规的文件检索服务(如FTP)的主要区别是Web内容使用HTML(Hypertext Markup Language)来编写，提供格式和布局的控制，并且可以包含超连接。

### Web内容

对于Web客户端和服务器而言，内容是与一个MIME(Multipurpose Internet Mail Extensions)类型相关的字节序列。

Web服务器以两种不同的方式向客户端提供内容:

1. 取一个磁盘文件，并将它的内容返回个客户端。
2. 运行一个可执行文件，并将它的输出返回个客户端。

每条有Web服务器返回的内容都是和它管理的的某个文件相关联的。这些文件中的每一个都有唯一的名字，交租URL(Universal Resource Locator)。例如:

    http://www.google.com:80/index.html

标识因特网主机www.google.com上一个称为/index.html的HTML文件，它是由一个监听端口80的Web服务器管理的。

可执行文件的URL可以在文件名后包括程序参数。`?`分隔文件名和参数，而且每个参数都用`&`分隔开。例如:

    http://example.com:80/cig-bin/adder?123&345

标识了一个叫做/cig-bin/adder的可执行文件，会带两个参数123和345来调用它。在事务过程中，客户端和服务器使用的URL的不同部分。例如，客户端使用前缀

    http://www.google.com:80

来决定与哪类服务器联系，服务器在哪，以及它监听的端口号是多少。服务器使用后缀

    /index.html

来发现在它文件系统中的文件，并确定请求的是动态内容还是静态内容。

### HTTP事务

#### 1.HTTP请求

    <method> <uri> <version>

#### 2.HTTP响应

    <version> <status code> <status message>

### 服务动态内容

CGI(Common Gateway Interface)的实际标准用来解决如下问题:

1. 客户端如何将参数传递给服务器

    Get请求的参数在URL中传递。一个`?`分割文件名和参数，而每个参数都用一个`&`字符隔开。参数中不允许有空格，而必须用字符串`%20`来表示，对于其他特殊字符，也存在着相似的编码。
    *POST请求的参数是在请求主体中而不是在URI中传递的*

2. 服务器如何将参数传递给子进程

    在服务器接收到一个如下的请求后
        
        GET /cgi-bin/adder?123&345
     
    它调用`fork`创建一个子进程，并调用`execve`在子进程的上下文中执行`/cgi-bin/adder`程序。像`adder`这样的程序，常常被称为CGI程序，因为它们遵守CGI标准。在调用`execve`之前，子进程将CGI环境变量`QUERY_STRING`设置为`123&345`，`adder`程序在运行时可以使用Unix `getenv`函数来引用它。

3. 服务器如何将其他信息传递给子进程

    CGI定义了大量的环境变量，一个CGI程序在它运行时可以设置这些环境变量。

4. 子进程将它的输出发送到哪里

    一个CGI程序将它的动态内容发送到标准输出。在子进程中加载并运行CGI程序之前，它使用Unix `dup2`函数将标准输出重定向到和客户端相关联的已连接描述符。因此，任何CGI程序写到标准输出的内容都会直接到达客户端。
    因为父进程不知道子进程生成的内容的类型和大小，所以子进程负责生成`Content-type`和`Content-length`响应报头，以及终止报头的空行。
